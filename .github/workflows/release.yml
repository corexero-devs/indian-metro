name: Android Release (manual → bump → build → Firebase → Play)

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Which part to bump?"
        type: choice
        options: [ MAJOR, MINOR, PATCH ]
        default: PATCH
        required: true
      city:
        description: "City to release"
        type: choice
        options: [ All, Mumbai, Delhi, Chennai, Bengaluru, Hyderabad, Kolkata, Kochi, Pune, Lucknow, Ahmedabad, Jaipur, Kanpur, Nagpur, Agra ]
        default: all
        required: true
      publish:
        description: "Publish to Play Store?"
        type: boolean
        default: false

permissions:
  contents: write

env:
  MODULE_PATH: metro

jobs:
  set_matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk.outputs.matrix }}
    steps:
      - id: mk
        shell: bash
        run: |
          ALL='["Mumbai","Delhi","Chennai","Bengaluru","Hyderabad","Kolkata","Kochi","Pune","Lucknow","Ahmedabad","Jaipur","Kanpur","Nagpur","Agra"]'
          SEL='${{ inputs.city }}'
          if [[ "$SEL" == "All" ]]; then
            echo "matrix={\"city\":$ALL}" >> "$GITHUB_OUTPUT"
          else
            echo "matrix={\"city\":[\"$SEL\"]}" >> "$GITHUB_OUTPUT"
          fi

  bump_version:
    runs-on: ubuntu-latest
    outputs:
      version_name: ${{ steps.bump.outputs.version_name }}
      version_code: ${{ steps.bump.outputs.version_code }}
      tag: ${{ steps.bump.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - id: bump
        shell: bash
        run: |
          set -euo pipefail
          FILE="version.properties"
          [[ -f "$FILE" ]] || { echo "version.properties not found"; exit 1; }
          
          # Read current padded version, e.g. VERSION=01.04.000
          CUR_LINE=$(grep -E '^VERSION=' "$FILE")
          CUR=${CUR_LINE#VERSION=}
          IFS='.' read -r MA MI PA <<< "$CUR"
          MA=$((10#$MA)); MI=$((10#$MI)); PA=$((10#$PA))
          
          case "${{ github.event.inputs.bump }}" in
            MAJOR) MA=$((MA+1)); MI=0; PA=0 ;;
            MINOR) MI=$((MI+1)); PA=0 ;;
            PATCH) PA=$((PA+1)) ;;
            *) echo "unknown bump"; exit 1 ;;
          esac
          
          # Padded version like 02.05.003
          printf -v NEW_NAME "%02d.%02d.%03d" "$MA" "$MI" "$PA"
          VERSION_CODE=$(( MA*100000 + MI*1000 + PA ))
          TAG="v${MA}.${MI}.${PA}"   # unpadded tag
          
          # Write back to version.properties
          sed -i -E "s/^VERSION=.*/VERSION=${NEW_NAME}/" "$FILE"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "chore: bump version to ${NEW_NAME} (${VERSION_CODE})"
          git tag "$TAG"
          git push --follow-tags
          
          echo "version_name=${NEW_NAME}" >> $GITHUB_OUTPUT
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

  build_aab:
    if: ${{ inputs.publish }}
    runs-on: ubuntu-latest
    needs: [ bump_version,set_matrix ]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.set_matrix.outputs.matrix) }}
    outputs:
      aab_path: ${{ steps.out.outputs.aab_path }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          submodules: true
          token: ${{ secrets.PAT_TOKEN }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - run: chmod +x ./gradlew

      - name: Build AAB for ${{ matrix.city }}
        env:
          ORG_GRADLE_PROJECT_kotlin_native_ignoreDisabledTargets: "true"
        run: ./gradlew :${{ env.MODULE_PATH }}:bundle${{matrix.city}}Release --stacktrace

      - id: out
        shell: bash
        run: |
          CITY_LC="$(printf '%s' "${{matrix.city}}" | tr '[:upper:]' '[:lower:]')"
          A1="${{ env.MODULE_PATH }}/build/outputs/bundle/${CITY_LC}Release/${{ env.MODULE_PATH }}-${CITY_LC}-release.aab"
          A2="${{ env.MODULE_PATH }}/build/outputs/aab/${CITY_LC}Release/${{ env.MODULE_PATH }}-${CITY_LC}-release.aab"
          [[ -f "$A1" ]] && AAB="$A1" || AAB="$A2"
          OUT="app-${{ matrix.city }}.aab"
          cp "$AAB" "$OUT"
          echo "aab_path=$OUT" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.MODULE_PATH }}-${{matrix.city}}-${{ needs.bump_version.outputs.version_name }}-release.aab
          path: ${{ steps.out.outputs.aab_path }}
  build_apk:
    runs-on: ubuntu-latest
    needs: [ set_matrix,bump_version ]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.set_matrix.outputs.matrix) }}
    outputs:
      apk_path: ${{ steps.out.outputs.apk_path }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          submodules: true
          token: ${{ secrets.PAT_TOKEN }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - run: chmod +x ./gradlew

      - name: Build Apk for ${{ matrix.city }}
        env:
          ORG_GRADLE_PROJECT_kotlin_native_ignoreDisabledTargets: "true"
        run: ./gradlew :${{ env.MODULE_PATH }}:assemble${{matrix.city}}Release --stacktrace

      - id: out
        shell: bash
        run: |
          CITY_LC="$(printf '%s' "${{matrix.city}}" | tr '[:upper:]' '[:lower:]')"
          APK="${{ env.MODULE_PATH }}/build/outputs/apk/${CITY_LC}/release/${{ env.MODULE_PATH }}-${CITY_LC}-release.apk"
          OUT="${{ env.MODULE_PATH }}-${CITY_LC}-release.apk"
          cp "$APK" "$OUT"
          echo "apk_path=$OUT" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.MODULE_PATH }}-${{matrix.city}}-${{ needs.bump_version.outputs.version_name }}-release.apk
          path: ${{ steps.out.outputs.apk_path }}
  distribute_firebase:
    runs-on: ubuntu-latest
    needs: [ bump_version, build_apk ]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.MODULE_PATH }}-${{matrix.city}}-${{ needs.bump_version.outputs.version_name }}-release.apk
          path: .

      - name: Distribute to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}                  # 1:…:android:…
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          file: ${{ needs.build_apk.outputs.apk_path }}
          releaseNotes: ${{ format('CI {0} • tag {1}', needs.bump_version.outputs.version_name, needs.bump_version.outputs.tag) }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.bump_version.outputs.tag }}
          name: "Android ${{ needs.bump_version.outputs.version_name }}"
          files: ${{ needs.build_apk.outputs.apk_path }}
